YUI.add("moodle-atto_filedragdrop-button",function(g,e){g.namespace("M.atto_filedragdrop").Button=g.Base.create("button",g.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){this.editor.on("drop",this._handleDragDrop,this)},_handleDragDrop:function(e){var t,i,o,r,a,n,d,l,p,s=this,f=this.get("host"),u=g.Handlebars.compile('<a href="{{url}}" {{#if id}}id="{{id}}" {{/if}}>{{text}}'),c=g.Handlebars.compile('<img src="{{url}}" {{#if alt}}alt="{{alt}}" {{/if}} style="vertical-align:text-bottom;margin: 0 .5em;" class="img-responsive" {{#if presentation}}role="presentation" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>');if(f.saveSelection(),(e=e._event).dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length&&!/^image\//.test(e.dataTransfer.files[0].type)){for(s.notifyUploadStarted(),i=(t=f.get("filepickeroptions").link).savepath===undefined?"/":t.savepath,o=new FormData,r=0,a="",n=new XMLHttpRequest,d="",l=Object.keys(t.repositories),e.preventDefault(),e.stopPropagation(),o.append("repo_upload_file",e.dataTransfer.files[0]),o.append("itemid",t.itemid),p=0;p<l.length;p++)if("upload"===t.repositories[l[p]].type){o.append("repo_id",t.repositories[l[p]].id);break}return o.append("env",t.env),o.append("sesskey",M.cfg.sesskey),o.append("client_id",t.client_id),o.append("savepath",i),o.append("ctx_id",t.context.id),r=(new Date).getTime(),a="moodlefile_"+Math.round(1e5*Math.random())+"-"+r,f.focus(),f.restoreSelection(),d=c({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading","atto_filedragdrop"),id:a}),f.insertContentAtFocusPoint(d),s.markUpdated(),n.onreadystatechange=function(){var e,t,i,o,r=s.editor.one("#"+a);if(4===n.readyState){if(200===n.status){if(e=JSON.parse(n.responseText)){if(e.error)return r&&r.remove(!0),s.notifyUploadCompleted(),new M.core.ajaxException(e);(t=e).event&&"fileexists"===e.event&&(t=e.newfile),i=u({url:t.url,text:t.file||t.filename}),o=g.Node.create(i),r?r.replace(o):s.editor.appendChild(o),s.markUpdated()}}else s.notifyUploadCompleted(),g.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),r&&r.remove(!0);s.notifyUploadCompleted()}},n.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),n.send(o),!1}},notifyUploadCompleted:function(){var t=this;require.specified("core_form/events")&&require(["core_form/events"],function(e){"undefined"!=typeof e.triggerUploadCompleted&&e.triggerUploadCompleted(t.editor.get("id"))})},notifyUploadStarted:function(){var t=this;require.specified("core_form/events")&&require(["core_form/events"],function(e){"undefined"!=typeof e.triggerUploadStarted&&e.triggerUploadStarted(t.editor.get("id"))})}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});